<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../">
  <title data-ice="title">Manual | corrode</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="A batteries-included library for reading binary data."><meta property="twitter:card" content="summary"><meta property="twitter:title" content="corrode"><meta property="twitter:description" content="A batteries-included library for reading binary data."></head>
<body class="layout-container manual-root" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/screeny05/corrode"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div class="manual-toc-root">
  
<div data-ice="manual">
    <ul class="manual-toc">
      
    <li data-ice="manualNav" class="indent-h1" data-link="manual/overview.html"><a href="manual/overview.html" data-ice="link">Overview</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="manual/overview.html"><a href="manual/overview.html#components" data-ice="link">Components</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="manual/overview.html"><a href="manual/overview.html#the-assertions" data-ice="link">The Assertions</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="manual/overview.html"><a href="manual/overview.html#the-mappers" data-ice="link">The Mappers</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="manual/overview.html"><a href="manual/overview.html#when-will-i-be-able-to-access-the-variables---extensions--asserts--amp--mappers-" data-ice="link">When will i be able to access the variables? (Extensions, Asserts &amp; Mappers)</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="manual/overview.html"><a href="manual/overview.html#corrode-position---corrode-skip-issues--isseeking-" data-ice="link">Corrode#position / Corrode#skip issues (isSeeking)</a></li>
</ul>
  </div>
<div data-ice="manual">
    <ul class="manual-toc">
      
    <li data-ice="manualNav" class="indent-h1" data-link="manual/getting-started.html"><a href="manual/getting-started.html" data-ice="link">Getting started</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="manual/getting-started.html"><a href="manual/getting-started.html#introduction" data-ice="link">Introduction</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="manual/getting-started.html"><a href="manual/getting-started.html#data-structure" data-ice="link">Data Structure</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="manual/getting-started.html"><a href="manual/getting-started.html#how-we--39-ll-do-this" data-ice="link">How we&apos;ll do this</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="manual/getting-started.html"><a href="manual/getting-started.html#let--39-s-get-started" data-ice="link">Let&apos;s get started</a></li>
<li data-ice="manualNav" class="indent-h3" data-link="manual/getting-started.html"><a href="manual/getting-started.html#the-header-parser" data-ice="link">The header parser</a></li>
<li data-ice="manualNav" class="indent-h3" data-link="manual/getting-started.html"><a href="manual/getting-started.html#the-index-parser" data-ice="link">The index parser</a></li>
<li data-ice="manualNav" class="indent-h4" data-link="manual/getting-started.html"><a href="manual/getting-started.html#the-index-entry-parser" data-ice="link">The index entry parser</a></li>
<li data-ice="manualNav" class="indent-h4" data-link="manual/getting-started.html"><a href="manual/getting-started.html#the-index-parser-itself" data-ice="link">The index parser itself</a></li>
<li data-ice="manualNav" class="indent-h3" data-link="manual/getting-started.html"><a href="manual/getting-started.html#the-data-parser" data-ice="link">The data parser</a></li>
<li data-ice="manualNav" class="indent-h4" data-link="manual/getting-started.html"><a href="manual/getting-started.html#the-data-entry-parser" data-ice="link">The data-entry parser</a></li>
<li data-ice="manualNav" class="indent-h4" data-link="manual/getting-started.html"><a href="manual/getting-started.html#the-data-parser-itself" data-ice="link">The data parser itself</a></li>
<li data-ice="manualNav" class="indent-h3" data-link="manual/getting-started.html"><a href="manual/getting-started.html#wiring-everything-together" data-ice="link">Wiring everything together</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="manual/getting-started.html"><a href="manual/getting-started.html#parsing-a-file" data-ice="link">Parsing a file</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="manual/getting-started.html"><a href="manual/getting-started.html#escaping-callback-hell" data-ice="link">Escaping callback-hell</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="manual/getting-started.html"><a href="manual/getting-started.html#further-reading" data-ice="link">Further reading</a></li>
</ul>
  </div>
<div data-ice="manual">
    <ul class="manual-toc">
      
    <li data-ice="manualNav" class="indent-h1" data-link="manual/configuration.html"><a href="manual/configuration.html" data-ice="link">Configuration</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="manual/configuration.html"><a href="manual/configuration.html#-code-endianness--code-" data-ice="link">endianness</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="manual/configuration.html"><a href="manual/configuration.html#-code-loopidentifier--code-" data-ice="link">loopIdentifier</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="manual/configuration.html"><a href="manual/configuration.html#-code-encoding--code-" data-ice="link">encoding</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="manual/configuration.html"><a href="manual/configuration.html#-code-finishjobsoneof--code-" data-ice="link">finishJobsOnEOF</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="manual/configuration.html"><a href="manual/configuration.html#-code-anonymousloopdiscarddeep--code-" data-ice="link">anonymousLoopDiscardDeep</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="manual/configuration.html"><a href="manual/configuration.html#-code-strictobjectmode--code-" data-ice="link">strictObjectMode</a></li>
</ul>
  </div>
<div data-ice="manual">
    <ul class="manual-toc">
      
    <li data-ice="manualNav" class="indent-h1" data-link="manual/CHANGELOG.html"><a href="manual/CHANGELOG.html" data-ice="link">Changelog</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="manual/CHANGELOG.html"><a href="manual/CHANGELOG.html#corrode-v1-0-2" data-ice="link">corrode v1.0.2</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="manual/CHANGELOG.html"><a href="manual/CHANGELOG.html#corrode-v1-0-1" data-ice="link">corrode v1.0.1</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="manual/CHANGELOG.html"><a href="manual/CHANGELOG.html#corrode-v1-0-0" data-ice="link">corrode v1.0.0</a></li>
</ul>
  </div>
</div>
</nav>

<div class="content" data-ice="content"><div class="github-markdown" data-ice="content"><h1 id="getting-started">Getting started</h1><h2 id="introduction">Introduction</h2><p>This document will guide you through most of the basic functionality of corrode by example.
Our goal is to parse a structured file for storing flat, arbitrary data.</p>
<h2 id="data-structure">Data Structure</h2><p>This will be the structure we are going to parse:</p>
<ul>
<li>Container - Little endian<ul>
<li>Header<ul>
<li>Magic Number [uint32 0xDEADBEEF]</li>
<li>File version<ul>
<li>major[uint32]</li>
<li>minor[uint32]</li>
</ul>
</li>
<li>File creation date[uint32 timestamp]</li>
<li>Data count[uint32]</li>
</ul>
</li>
<li>Data Index (array)<ul>
<li>Name[string&lt;utf8&gt;, terminated by 0x00]</li>
<li>Offset[uint32]</li>
<li>Length[uint32]</li>
<li>Flags[uint8]<ul>
<li>Compression[0x80]</li>
<li>Encryption[0x40]</li>
<li>Read only[0x20]</li>
</ul>
</li>
<li>Checksum [Buffer&lt;32&gt;]</li>
</ul>
</li>
<li>Data (array)<ul>
<li>Data[buffer&lt;Length&gt;]</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="how-we--39-ll-do-this">How we&apos;ll do this</h2><p>To better structure our code, we will split it into three main parsers: Header, Index, Data.</p>
<p>For cases like this, there&apos;s <code>Corrode.addExtension</code>, which is let&apos;s us break down big pieces of code.</p>
<p>Apart from this function and the basic read-structures there are also assertions and mappers.</p>
<p>Assertions allow us to test the parsed data on whether or not it matches certain requirements. This helps in making sure, that the data we parse aligns with our specification. When an assertion is not met, corrode will throw an <code>Error</code> and halt execution.</p>
<p>Mappers provide us with a way to transform read data into something different, or mapping certain values to other ones.</p>
<p>The Header-parser will show you the basics of their usage.</p>
<h2 id="let--39-s-get-started">Let&apos;s get started</h2><h3 id="the-header-parser">The header parser</h3><pre><code class="lang-javascript"><code class="source-code prettyprint">/**
 * reads header data from our own specified format
 * @throws Error magic number doesn&apos;t match
 * @return {Object} header-data
 * @example
 * {
 *   magic: 0xDEADBEEF,
 *   version: { major: uint32, minor: uint32 },
 *   timestamp: Date,
 *   dataCount: uint32
 * }
 */
Corrode.addExtension(&apos;containerHeader&apos;, function containerHeaderParser(){
    this
        // read the magic number and compare it against a fixed value
        .uint32(&apos;magic&apos;)
        .assert.equal(&apos;magic&apos;, 0xDEADBEEF)

        // tap creates a new named object (version), into which we can write data
        // also it allows us to acces data, read up to this point of parsing
        .tap(&apos;version&apos;, function(){
            this
                .uint32(&apos;major&apos;)
                .uint32(&apos;minor&apos;);
        })

        // read the timestamp and convert it into a native Date object via a custom mapper
        .uint32(&apos;timestamp&apos;)
        .map.callback(&apos;timestamp&apos; t =&gt; new Date(t))

        .uint32(&apos;dataCount&apos;);
});</code>
</code></pre>
<p>This is all we need for parsing any header of this structure. See how this assert makes sure we have the correct file? And how we&apos;re able to convert an uint32 into a native js Date object? This is how we roll.</p>
<h3 id="the-index-parser">The index parser</h3><p>Let&apos;s spice things up a bit, by creating our index parser. It needs access to the parsed data of the header, because there&apos;s the data-count of the whole file.</p>
<p>Also, instead of just one we will create two extensions for parsing the index:</p>
<ul>
<li>One that parses the index itself</li>
<li>Another one that parses each index-entry</li>
</ul>
<h4 id="the-index-entry-parser">The index entry parser</h4><pre><code class="lang-javascript"><code class="source-code prettyprint">/**
 * reads the data of an index-entry
 * @return {Object} index-entry
 * @example
 * {
 *   name: string,
 *   offset: uint32,
 *   length: uint32,
 *   flags: { isCompressed: bool, isEncrypted: bool, isReadOnly: bool },
 *   checksum: Buffer&lt;32&gt;
 * }
 */
Corrode.addExtension(&apos;containerIndexEntry&apos;, function containerIndexEntryParser(){
    this
        // parse a string terminated by 0x00 (default)
        .terminatedString(&apos;name&apos;)

        .uint32(&apos;offset&apos;)
        .uint32(&apos;length&apos;)

        // read the bits for the flags and parse them with bitwise opearators
        .uint8(&apos;flags&apos;)
        .map.callback(&apos;flags&apos;, bits =&gt; ({
            isCompressed: (bits &amp; 0x80) === 0x80,
            isEncrypted: (bits &amp; 0x40) === 0x40,
            isReadOnly: (bits &amp; 0x20) === 0x20
        }))

        // we&apos;ll check this later, when parsing the data
        .buffer(&apos;checksum&apos;, 32);
});</code>
</code></pre>
<h4 id="the-index-parser-itself">The index parser itself</h4><pre><code class="lang-javascript"><code class="source-code prettyprint">/**
 * reads the data of the container-index
 * @param {Object&lt;containerHeader&gt;} header parsed header-data of the container-file
 * @return {Array&lt;containerIndexEntry&gt;} index
 */
Corrode.addExtension(&apos;containerIndex&apos;, function containerIndexParser(header){
    this
        .repeat(&apos;entries&apos;, header.dataCount, function(){
            this
                // call our indexEntry-extension and push the result into the
                // entries-array created by Corrode#repeat
                .ext.containerIndexEntry(&apos;entry&apos;)
                .map.push(&apos;entry&apos;);
        })

        // the push function replaces the current value in `this.vars` with the
        // one found under the given name. This way we&apos;re able to return an array
        // of entries here, instead of an object like this { entries: [...] }
        .map.push(&apos;entries&apos;);
});</code>
</code></pre>
<p>As you can see, this is a rather simple extension. It executes the containerIndexEntry parser as many times as the header says there are files in the container. The <code>repeat</code>-function creates a new array in the current variable-layer (@TODO see Overview).</p>
<p>By using the <code>map.push</code>-function we replace the current variable-layer with our own value. So instead of returning an object containing an array of objects containing the data, we just get an array of index-entries.</p>
<h3 id="the-data-parser">The data parser</h3><p>We will also split the data-parser into two. Again there will be a parser for the entries and one for the data itself.</p>
<p>We don&apos;t do this because of technical limitations, but because i like to have clean and separate functions for everything. If you want to, you can still smooch the entry-parser into into the repeat.</p>
<h4 id="the-data-entry-parser">The data-entry parser</h4><pre><code class="lang-javascript"><code class="source-code prettyprint">/**
 * reads the data of a data-entry
 * @throws Error callback doesn&apos;t match
 * @param {Object&lt;containerIndexEntry&gt;} indexEntry
 * @return {Buffer} data
 */
Corrode.addExtension(&apos;containerDataEntry&apos;, function containerDataEntryParser(indexEntry){
    this
        // jump to the offset of the entry
        .position(index.offset)

        // get buffer (it&apos;s a slice, not a copy)
        .buffer(&apos;data&apos;, index.length)

        // check, that the checksum of the data matches the one given
        .assert.callback(&apos;data&apos;, data =&gt; someChecksumFunction(data) === index.checksum, &apos;checksum&apos;)

        // only return the buffer
        .map.push(&apos;data&apos;);
});</code>
</code></pre>
<p>Note that the position-function works in a slightly restricted way, in that it only allows skipping forward without any additional configuration. @TODO See <code>Corrode#isSeeking</code> for more info.</p>
<p>In the way there&apos;s a <code>map.callback</code> there&apos;s also a <code>assert.callback</code> taking a function by which it checks the incoming value.</p>
<h4 id="the-data-parser-itself">The data parser itself</h4><pre><code class="lang-javascript"><code class="source-code prettyprint">/**
 * read container data
 * @param {Object&lt;containerIndex&gt;} index
 * @return {Array&lt;containerDataEntry&gt;} container-data
 */
Corrode.addExtension(&apos;containerData&apos;, function containerDataParser(index){
    this
        .repeat(&apos;entries&apos;, index.length, function(end, discard, i){
            const indexEntry = index[i];

            this
                .ext.containerDataEntry(&apos;entryData&apos;, indexEntry)
                .tap(function(){
                    const data = this.vars.entryData;
                    this.vars = indexEntry;

                    if(this.vars.flags.)
                    this.vars.data = data;
                });
        })
        .map.push(&apos;entries&apos;);
});</code>
</code></pre>
<h3 id="wiring-everything-together">Wiring everything together</h3><pre><code class="lang-javascript"><code class="source-code prettyprint">Corrode.addExtension(&apos;container&apos;, function containerParser(){
    this
        .ext.containerHeader(&apos;header&apos;)
        .tap(function(){
            this
                .ext.containerIndex(&apos;index&apos;, this.vars.header)
                .tap(function(){
                    this.ext.containerData(&apos;data&apos;, this.vars.index);
                });
        })
        .map.push(&apos;data&apos;);
});</code>
</code></pre>
<h2 id="parsing-a-file">Parsing a file</h2><pre><code class="lang-javascript"><code class="source-code prettyprint">const parser = new Corrode();
parser
    .ext.container(&apos;container&apos;)
    .map.push(&apos;container&apos;);

const fstream = fs.createReadStream(&apos;./container&apos;);
fstream.pipe(parser);

parser.on(&apos;finish&apos;, () =&gt; {
    console.log(parser.vars);
});</code>
</code></pre>
<h2 id="escaping-callback-hell">Escaping callback-hell</h2><pre><code class="lang-javascript"><code class="source-code prettyprint">Corrode.addExtension(&apos;containerIndex&apos;, function containerIndexParser(header){
    if(typeof header === &apos;string&apos;){
        header = this.vars[header];
    }

    ...
});</code>
</code></pre>
<pre><code class="lang-javascript"><code class="source-code prettyprint">Corrode.addExtension(&apos;container&apos;, function containerParser(){
    this
        .ext.containerHeader(&apos;header&apos;)
        .ext.containerIndex(&apos;index&apos;, &apos;header&apos;)
        .ext.containerData(&apos;data&apos;, &apos;index&apos;)
        .map.push(&apos;data&apos;);
});</code>
</code></pre>
<h2 id="further-reading">Further reading</h2><ul>
<li>Configuration</li>
<li>Examples</li>
</ul>
</div>
</div>

<footer class="footer">
  Generated by <a href="https://esdoc2.org">esdoc2<span data-ice="esdocVersion">(2.1.3)</span><img src="./image/esdoc2-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
